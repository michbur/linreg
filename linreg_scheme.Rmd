---
title: "linreg algorithm - R implementation"
author: "Michal Burdukiewicz"
date: "May 29, 2015"
output:
  html_document:
    toc: yes
---


# Questions

## Scheme questions

Naming convention: Q, number of part (roman numerals), underscore, number of question on scheme (greek numerals).

```{r,echo=FALSE,message=FALSE,results='asis'}
#Each question must start with Q/[no space/]numberOfPart_numberOfQuestion.
#Only one question per line.
source("extract_questions.R")

cat(extract_questions("linreg_scheme.Rmd"))

```

## Additional questions

From manual: "Corrected a bug that occurred when the plateau phase data were not fully continuously increasing. This then resulted in a two plateau phase points being selected and the sample being excluded. Note that this correction can lead to changed results when data are re-analysed." - how bug was corrected?


# List of abbrevations

* BL: baseline.
* S_L: slope of points in the lower half of the exponential phase.
* S_U: slope of points in the upper half of the exponential phase.
* SDM: second derivative maximum, end of the exponential phase.
* Start of the exponential phase: a cycle C for which (counting from plateau) fluorescence value is bigger than in cycle C + 1.


# Baselining


## Part 0

```{r,echo=FALSE}
library(DiagrammeR)
diagram <- "
graph TB
subgraph linreg
A[raw sample]==>B[set baseline to <br/> minimum observation]
B==>C[apply baseline]
C==>D{check for amplification <br/> Samples are skipped when less than seven times <br/> increase in fluorescence values is observed}
D== yes ==>Eyes[Determine SDM cycle: <br/> end of the exponential phase]
D== no ==>Eno[skip sample]
Eyes==>F[Move to Part I]

style A fill:#DCEBE3
style B fill:#77DFC9
style C fill:#DEDBBA
style D fill:#77DFC9
style Eyes fill:#DEDBBA
style Eno fill:#DEDBBA
end

subgraph questions
A2[no questions]==>B2[no questions]
B2==>C2[Q0_1. Linreg manual indicates that apply baseline means substract baseline. <br/> If the baseline is smaller than 0, should it be also substracted?]
C2==>D2[Q0_2. If the minimum value is 0, should I add a small epsilon to fluoescence values?]
D2== yes ==>Eyes2[Q0_3. Which algorithm was used for numerical derivation?]

D2== no ==>Eno2[no questions]

style A2 fill:#DCEBE3
style B2 fill:#77DFC9
style C2 fill:#DEDBBA
style D2 fill:#77DFC9
style Eyes2 fill:#DEDBBA
style Eno2 fill:#DEDBBA
end
"

mermaid(diagram)
```

## Part I

```{r,echo=FALSE}

diagram <- "
graph TB
subgraph linreg
START[Move from part 0]==>A[Determine start of the exponential phase.]
A==>B[set baseline too high: <br/> baseline is the average of the 6th and the 7th point <br/> below the plateau phase]
B==>C[apply baseline]
C==>D{compare S_U and S_L <br/> When the exponential phase has an uneven number of points, <br/> the middle point is in the top as well as the bottom part}
F== no ==>C
D== S_U > S_L ==>Esmaller[Define step: 0.005*baseline]
D== S_U < S_L ==>Ebigger[Decrease baseline by 0.01]
Ebigger==>F{baseline < min. observ}
F== yes ==>G[baseline error]
Esmaller==>H[Move to part II]

style A fill:#77DFC9
style B fill:#DEDBBA
style C fill:#77DFC9
style D fill:#DEDBBA
style Ebigger fill:#77DFC9
style Esmaller fill:#77DFC9
style F fill:#DEDBBA
style G fill:#77DFC9
end

subgraph questions
START2[Move from part 0]==>A2[QI_1. Hot to define start of the exponential phase  if there are no detectable jump?]
A2==>B2[QI_2. Ho to set a baseline as the average of the 6th and the 7th point below the plateau phase <br/> when plateau phase is not visible?]
B2==>C2[no questions]
C2==>D2[no questions]
D2== S_U > S_L ==>Esmaller2[no questions]
D2== S_U < S_L ==>Ebigger2[no questions]
Ebigger2==>F2[no questions]
F2== no ==>C2
F2== yes ==>G2[no questions]

style A2 fill:#77DFC9
style B2 fill:#DEDBBA
style C2 fill:#77DFC9
style D2 fill:#DEDBBA
style Ebigger2 fill:#77DFC9
style Esmaller2 fill:#77DFC9
style F2 fill:#DEDBBA
style G2 fill:#77DFC9
end
"

mermaid(diagram)
```


## Part II

```{r,echo=FALSE}

diagram <- "
graph TB
subgraph linreg
START[Move from part I]==>A[BL = BL + step]
A==>B[apply baseline]
B==>C{compare S_U and S_L}
Dbigger[BL = BL - 2.step <br/> step = 0.5*step]==>B
C==S_U - S_L < 1e-05==>E[Baseline corrected sample]
C== S_U < S_L ==>Dbigger
C== S_U > S_L ==>A

style A fill:#77DFC9
style B fill:#DEDBBA
style C fill:#77DFC9
style Dbigger fill:#DEDBBA
style E fill:#DEDBBA
end

subgraph questions
START2[Move from part I]==>A2[QII_1. what if step is negative? should it be added or substracted?]
A2==>B2[no questions]
B2==>C2[no questions]
C2== S_U < S_L ==>Dbigger2[QII_2. what means 2.step?]
Dbigger2==>B2
C2== S_U - S_L < 1e-05 ==>E2[no questions]
C2== S_U > S_L ==>A2

style A2 fill:#77DFC9
  style B2 fill:#DEDBBA
  style C2 fill:#77DFC9
  style Dbigger2 fill:#DEDBBA
  style E2 fill:#DEDBBA
  end
"

mermaid(diagram)
```

